<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S & K Fuel Monitor</title>
    <style>
        body { background: transparent; margin: 0; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        .billboard-link { text-decoration: none; cursor: pointer; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .billboard-frame { background: #111; border: 8px solid #2a2a2a; border-radius: 4px; padding: 10px; position: relative; width: 100%; height: 100%; max-width: 500px; aspect-ratio: 16 / 11; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.8); }
        .brand-overlay { position: absolute; top: 0; width: 100%; background: #3e0100; color: #ffc929; font-weight: bold; text-align: center; font-size: 14px; padding: 8px 0; border-bottom: 2px solid #ffc929; z-index: 10; letter-spacing: 1px; }
        .brand-footer { position: absolute; bottom: 0; width: 100%; background: #3e0100; color: #ffc929; font-weight: bold; text-align: center; font-size: 14px; padding: 8px 0; border-top: 2px solid #ffc929; z-index: 10; letter-spacing: 0.5px; }
        .digital-screen { width: 95%; height: 70%; background: #000; border-radius: 5px; position: relative; overflow: hidden; border: 1px solid #333; display: flex; align-items: center; justify-content: center; }
        .gas-slide { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 1s ease-in-out; }
        .town-header { color: #888; font-size: 11px; letter-spacing: 3px; margin-bottom: 10px; }
        .station-logo { max-height: 25%; max-width: 70%; margin-bottom: 15px; }
        .price-row { width: 75%; display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
        .price-label { color: #444; font-size: 10px; font-weight: bold; }
        .led-red { color: #ff3b3b; text-shadow: 0 0 10px #ff0000; font-family: monospace; font-size: 2.2rem; font-weight: bold; }
        .led-grn { color: #39ff14; text-shadow: 0 0 10px #228b22; font-family: monospace; font-size: 2.2rem; font-weight: bold; }
        .update-tag { color: #444; font-size: 9px; margin-top: 10px; }
        @media (max-width: 400px) { .brand-overlay, .brand-footer { font-size: 11px; padding: 6px 0; } .led-red, .led-grn { font-size: 1.8rem; } }
    </style>
</head>
<body>

<a href="https://supportmylocalcommunity.com/gas-prices/" target="_parent" class="billboard-link">
    <div class="billboard-frame">
        <div class="brand-overlay">S & K Ventures, Inc. â€¢ Digital Advertising</div>
        <div class="digital-screen" id="screen">
            <div style="color: white; font-family: sans-serif; text-align: center;">Syncing Feed...</div>
        </div>
        <div class="brand-footer">Click billboard to update prices</div>
    </div>
</a>

<script>
const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_qODviVvfoveVKlgrOmJkCxIqLw1gfvftvlDGnZMDALQxcvph8o0MgVK11mhIeETQnagbNbqf2aER/pub?gid=1150011142&single=true&output=csv';

// THESE MATCH YOUR STOREID LIST AND GITHUB IMAGES
const stationConfigs = {
    "48101": { town: "flora", display: "Flora", logo: "hucks.png" },      
    "48100": { town: "flora", display: "Flora", logo: "caseys.png" },     
    "128128": { town: "flora", display: "Flora", logo: "mach1.png" },    
    "120226": { town: "flora", display: "Flora", logo: "faststop.png" },  
    "48026": { town: "clay-city", display: "Clay City", logo: "caseys.png" }, 
    "171711": { town: "xenia", display: "Xenia", logo: "knapps.png" },      
    "87817": { town: "louisville", display: "Louisville", logo: "caseys.png" }  
};

const urlParams = new URLSearchParams(window.location.search);
const targetTown = urlParams.get('town')?.toLowerCase();

async function initBillboard() {
    try {
        const res = await fetch(sheetUrl);
        const csvText = await res.text();
        const rows = csvText.split(/\r?\n/).map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));

        let latestData = JSON.parse(localStorage.getItem('sk_fuel_data')) || {};
        rows.forEach((cols, i) => {
            if (i === 0 || cols.length < 4) return;
            const idMatch = (cols[1] || "").match(/\d+/); 
            const id = idMatch ? idMatch[0] : null;
            if (id && stationConfigs[id]) {
                const regVal = cols[2] ? cols[2].replace(/[ "$]/g, "").trim() : "";
                const dslVal = cols[3] ? cols[3].replace(/[ "$]/g, "").trim() : "";
                if (regVal !== "" && regVal !== "0") {
                    latestData[id] = { reg: regVal, dsl: dslVal, date: cols[0].split(' ')[0], timestamp: Date.now() };
                }
            }
        });

        localStorage.setItem('sk_fuel_data', JSON.stringify(latestData));
        const screen = document.getElementById('screen');
        screen.innerHTML = ''; 

        const filteredIds = Object.keys(stationConfigs).filter(id => {
            if (!targetTown) return true; 
            return stationConfigs[id].town === targetTown;
        });

        filteredIds.forEach(id => {
            const config = stationConfigs[id];
            const data = latestData[id];
            const isStale = data && (Date.now() - data.timestamp > (30 * 24 * 60 * 60 * 1000));
            
            const displayReg = (data && !isStale) ? data.reg : "---";
            const displayDsl = (data && !isStale && data.dsl !== "0") ? data.dsl : "---";
            const displayDate = (data && !isStale) ? data.date : 'STALE';

            const slide = document.createElement('div');
            slide.className = 'gas-slide';
            slide.innerHTML = `
                <div class="town-header">${config.display.toUpperCase()}, IL</div>
                <img src="https://raw.githubusercontent.com/KFruti88/Clay-County-Fuel/main/images/${config.logo}" class="station-logo">
                <div class="price-row"><span class="price-label">REGULAR</span><span class="led-red">${displayReg}</span></div>
                <div class="price-row"><span class="price-label">DIESEL</span><span class="led-grn">${displayDsl}</span></div>
                <div class="update-tag">UPDATED: ${displayDate}</div>
            `;
            screen.appendChild(slide);
        });

        const slides = document.querySelectorAll('.gas-slide');
        let current = 0;
        if (slides.length > 0) {
            function showNext() {
                slides.forEach((s, i) => s.style.opacity = (i === current) ? "1" : "0");
                current = (current + 1) % slides.length;
            }
            showNext();
            if (window.billboardInterval) clearInterval(window.billboardInterval);
            window.billboardInterval = setInterval(showNext, 6000); 
        }
    } catch (err) { 
        console.error("Refresh failed.");
    }
}
initBillboard();
setInterval(initBillboard, 300000); 
</script>
</body>
</html>
